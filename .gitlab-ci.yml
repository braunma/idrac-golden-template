# =============================================================================
# iDRAC Golden Template — GitLab CI/CD Pipeline
# =============================================================================
#
# Required CI/CD Variables (Settings → CI/CD → Variables):
#   IDRAC_USERNAME      - iDRAC username           (masked)
#   IDRAC_PASSWORD      - iDRAC password           (masked, protected)
#
# Optional CI/CD Variables:
#   IDRAC_GROUP         - Target a specific server group (default: all groups)
#   IDRAC_SOURCE_IP     - Source iDRAC IP           (legacy mode only)
#   IDRAC_TARGET_IPS    - Comma-separated targets   (legacy mode only)
#   GL_TOKEN            - Project access token with write_repository scope;
#                         required only when pipeline.commit_exports: true
#   CA_Chain            - PEM-encoded CA certificate chain for your GitLab
#                         instance (file variable); required when GitLab uses
#                         a self-signed or private CA
#
# Pipeline stages:
#   1. validate   — lint + connectivity check  (manual)
#   2. export     — export golden template     (manual override)
#   3. import     — apply template to targets  (manual override)
#   4. pipeline   — config-driven: runs whatever steps are set in config.yaml
#
# Recommended workflow:
#   Configure pipeline.steps in config.yaml, then trigger "run_pipeline".
#   Use the individual export/import jobs above for one-off manual overrides.
# =============================================================================

stages:
  - validate
  - export
  - import
  - pipeline

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"
  IDRAC_CONFIG_FILE: "config.yaml"

default:
  image: python:3.11-slim
  before_script:
    - |
      echo "==========================================="
      echo "Job: $CI_JOB_NAME"
      echo "Pipeline: $CI_PIPELINE_ID"
      echo "Branch: $CI_COMMIT_REF_NAME"
      echo "Runner: $CI_RUNNER_DESCRIPTION"
      echo "==========================================="
      apt-get update -qq && apt-get install -y --no-install-recommends git ca-certificates
      if [ -n "$CA_Chain" ]; then
        echo "--- Installing custom CA certificate ---"
        echo "$CA_Chain" > /usr/local/share/ca-certificates/gitlab-custom-ca.crt
        update-ca-certificates
      fi
      pip install --quiet -r requirements.txt
  cache:
    key: "$CI_COMMIT_REF_SLUG"
    paths:
      - .pip-cache/

# ---------------------------------------------------------------------------
# Stage 1: Validate
# ---------------------------------------------------------------------------

lint:
  stage: validate
  script:
    - echo "--- Python syntax check ---"
    - python -m py_compile main.py
    - python -m py_compile src/idrac_common.py
    - python -m py_compile src/export_scp.py
    - python -m py_compile src/import_scp.py
    - echo "--- All files compile OK ---"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

validate_connectivity:
  stage: validate
  script:
    - echo "--- Validating iDRAC connectivity ---"
    - |
      GROUP_FLAG=""
      if [ -n "$IDRAC_GROUP" ]; then
        GROUP_FLAG="--group $IDRAC_GROUP"
      fi
      python main.py --verbose $GROUP_FLAG validate
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
      allow_failure: true
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true

# ---------------------------------------------------------------------------
# Stage 2: Export golden template
# ---------------------------------------------------------------------------

export_template:
  stage: export
  script:
    - echo "--- Exporting golden template from source iDRAC(s) ---"
    - |
      GROUP_FLAG=""
      if [ -n "$IDRAC_GROUP" ]; then
        GROUP_FLAG="--group $IDRAC_GROUP"
      fi
      python main.py --verbose $GROUP_FLAG export
    - |
      # Auto-commit exported templates when pipeline.commit_exports: true
      COMMIT_EXPORTS=$(python -c "import yaml; c=yaml.safe_load(open('${IDRAC_CONFIG_FILE}')); print('true' if c.get('pipeline', {}).get('commit_exports', False) else 'false')" 2>/dev/null || echo 'false')
      if [ "$COMMIT_EXPORTS" = "true" ]; then
        echo "--- Auto-committing exported templates ---"
        if [ -z "$GL_TOKEN" ]; then
          echo "ERROR: GL_TOKEN is not set. Add a project access token with"
          echo "       write_repository scope as a masked CI/CD variable."
          exit 1
        fi
        git config user.email "ci-bot@${CI_SERVER_HOST}"
        git config user.name "GitLab CI"
        git add templates/
        if git diff --cached --quiet; then
          echo "No template changes to commit."
        else
          git commit -m "ci: export golden templates [pipeline #${CI_PIPELINE_ID}]"
          git push \
            "https://oauth2:${GL_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" \
            "HEAD:${CI_COMMIT_REF_NAME}"
          echo "Templates committed and pushed."
        fi
      fi
    - echo "--- Listing exported files ---"
    - ls -lh templates/
  artifacts:
    paths:
      - templates/
    expire_in: 30 days
    name: "golden-template-${CI_PIPELINE_ID}"
  rules:
    - if: $CI_COMMIT_BRANCH
      when: manual

# ---------------------------------------------------------------------------
# Stage 3: Import template to targets
# ---------------------------------------------------------------------------

import_template:
  stage: import
  script:
    - echo "--- Importing golden template to target iDRACs ---"
    - |
      GROUP_FLAG=""
      if [ -n "$IDRAC_GROUP" ]; then
        GROUP_FLAG="--group $IDRAC_GROUP"
      fi
      # If groups are configured with template paths, just run import directly.
      # For legacy mode, find the most recent exported template.
      if python -c "import yaml; c=yaml.safe_load(open('$IDRAC_CONFIG_FILE')); exit(0 if 'groups' in c else 1)" 2>/dev/null; then
        python main.py --verbose $GROUP_FLAG import
      else
        TEMPLATE_FILE=$(ls -t templates/scp_*.xml templates/scp_*.json 2>/dev/null | head -1)
        if [ -z "$TEMPLATE_FILE" ]; then
          echo "ERROR: No exported template found in templates/"
          exit 1
        fi
        echo "Using template: $TEMPLATE_FILE"
        python main.py --verbose import "$TEMPLATE_FILE"
      fi
  rules:
    - if: $CI_COMMIT_BRANCH
      when: manual

# ---------------------------------------------------------------------------
# Full apply: export + import in one step
# ---------------------------------------------------------------------------

apply_template:
  stage: import
  script:
    - |
      echo '--- Full apply: export from source, import to all targets ---'

      GROUP_FLAG=""
      if [ -n "$IDRAC_GROUP" ]; then
        GROUP_FLAG="--group $IDRAC_GROUP"
      fi

      python main.py --verbose $GROUP_FLAG apply

      echo '--- Listing exported files ---'
      ls -lh templates/
  artifacts:
    paths:
      - templates/
    expire_in: 30 days
    name: "golden-template-applied-${CI_PIPELINE_ID}"
  rules:
    - if: $CI_COMMIT_BRANCH
      when: manual

# ---------------------------------------------------------------------------
# Config-driven pipeline: trigger this job to run whatever is in config.yaml
# ---------------------------------------------------------------------------
# Edit pipeline.steps in config.yaml to choose what happens:
#   steps: [validate, export]          → snapshot configs, commit to git
#   steps: [validate, import]          → apply committed templates to servers
#   steps: [apply]                     → export fresh + immediately apply
#
# Set pipeline.commit_exports: true (and add GL_TOKEN variable) to have
# exported templates automatically committed back to the repository.
# ---------------------------------------------------------------------------

run_pipeline:
  stage: pipeline
  script:
    - echo "--- Config-driven pipeline ---"
    - |
      GROUP_FLAG=""
      if [ -n "$IDRAC_GROUP" ]; then
        GROUP_FLAG="--group $IDRAC_GROUP"
      fi
      python main.py --verbose $GROUP_FLAG pipeline
    - |
      # Auto-commit exported templates when pipeline.commit_exports: true
      COMMIT_EXPORTS=$(python -c "import yaml; c=yaml.safe_load(open('${IDRAC_CONFIG_FILE}')); print('true' if c.get('pipeline', {}).get('commit_exports', False) else 'false')" 2>/dev/null || echo 'false')
      if [ "$COMMIT_EXPORTS" = "true" ]; then
        echo "--- Auto-committing exported templates ---"
        if [ -z "$GL_TOKEN" ]; then
          echo "ERROR: GL_TOKEN is not set. Add a project access token with"
          echo "       write_repository scope as a masked CI/CD variable."
          exit 1
        fi
        git config user.email "ci-bot@${CI_SERVER_HOST}"
        git config user.name "GitLab CI"
        git add templates/
        if git diff --cached --quiet; then
          echo "No template changes to commit."
        else
          git commit -m "ci: export golden templates [pipeline #${CI_PIPELINE_ID}]"
          git push \
            "https://oauth2:${GL_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" \
            "HEAD:${CI_COMMIT_REF_NAME}"
          echo "Templates committed and pushed."
        fi
      fi
    - echo "--- Listing templates/ ---"
    - ls -lh templates/
  artifacts:
    paths:
      - templates/
    expire_in: 30 days
    name: "pipeline-${CI_PIPELINE_ID}"
  rules:
    - if: $CI_COMMIT_BRANCH
      when: manual
